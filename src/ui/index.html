<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuFill - Document Template Filler</title>
    <link rel="icon" type="image/png" href="../resources/AppIcon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mantine/core@7.12.2/styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            min-height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #e9ecef;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 0 20px 24px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: #212529;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-icon {
            width: 36px;
            height: 36px;
            background-image: url('../resources/AppIcon.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
        }
        
        .sidebar-item {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-item:hover {
            background-color: #f8f9fa;
            color: #228be6;
        }
        
        .sidebar-item.active {
            background-color: #e7f5ff;
            color: #228be6;
            border-right: 3px solid #228be6;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6c757d;
            font-size: 16px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
            border: 1px solid #e9ecef;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 0;
        }
        
        .template-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .template-card:hover {
            border-color: #228be6;
            box-shadow: 0 4px 12px rgba(34, 139, 230, 0.15);
            transform: translateY(-2px);
        }
        
        .template-card.invalid {
            border-color: #fa5252;
            opacity: 0.7;
        }
        
        .template-card.invalid:hover {
            border-color: #fa5252;
            cursor: pointer;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(250, 82, 82, 0.15);
        }
        
        .template-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #228be6 0%, #1971c2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }
        
        .template-card.invalid .template-icon {
            background: linear-gradient(135deg, #fa5252 0%, #e03131 100%);
        }
        
        .template-name {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }
        
        .template-info {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background-color: white;
            color: #212529;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #228be6;
            box-shadow: 0 0 0 3px rgba(34, 139, 230, 0.1);
        }
        
        .form-note {
            font-size: 13px;
            color: #6c757d;
            margin-top: 6px;
            display: flex;
            align-items: start;
            gap: 6px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: #228be6;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #1c7ed6;
        }
        
        .btn-secondary {
            background-color: #868e96;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #6c757d;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid #228be6;
            color: #228be6;
        }
        
        .btn-outline:hover:not(:disabled) {
            background-color: #228be6;
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        
        .alert {
            padding: 14px 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: flex;
            align-items: start;
            gap: 12px;
            font-size: 14px;
        }
        
        .alert-success {
            background-color: #d3f9d8;
            border: 1px solid #8ce99a;
            color: #2b8a3e;
        }
        
        .alert-error {
            background-color: #ffe0e0;
            border: 1px solid #ffa8a8;
            color: #c92a2a;
        }
        
        .alert-warning {
            background-color: #fff4e6;
            border: 1px solid #ffc078;
            color: #e67700;
        }
        
        .multi-input-container {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 8px;
            min-height: 44px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            transition: all 0.2s;
        }
        
        .multi-input-container:focus-within {
            border-color: #228be6;
            box-shadow: 0 0 0 3px rgba(34, 139, 230, 0.1);
        }
        
        .tag {
            background-color: #e7f5ff;
            color: #1971c2;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .tag-remove:hover {
            opacity: 1;
        }
        
        .tag-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 120px;
            font-size: 14px;
            font-family: inherit;
            padding: 4px;
        }
        
        .add-value-btn {
            background-color: #228be6;
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s;
            margin-left: 8px;
        }
        
        .add-value-btn:hover {
            background-color: #1c7ed6;
            transform: scale(1.05);
        }
        
        .add-value-btn:active {
            transform: scale(0.95);
        }
        
        .value-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .value-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background-color: white;
            color: #212529;
            transition: all 0.2s;
        }
        
        .value-input:focus {
            outline: none;
            border-color: #228be6;
            box-shadow: 0 0 0 3px rgba(34, 139, 230, 0.1);
        }
        
        .remove-value-btn {
            background-color: #fa5252;
            color: white;
            border: none;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            margin-left: 8px;
        }
        
        .remove-value-btn:hover {
            background-color: #e03131;
            transform: scale(1.05);
        }
        
        .remove-value-btn:active {
            transform: scale(0.95);
        }
        
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        
        .folder-card {
            text-align: center;
            padding: 40px 24px;
        }
        
        .folder-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #228be6 0%, #1971c2 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #228be6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .badge-success {
            background-color: #d3f9d8;
            color: #2b8a3e;
        }
        
        .badge-error {
            background-color: #ffe0e0;
            color: #c92a2a;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 400px;
            max-width: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid #e9ecef;
            padding: 20px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }
        
        .toast-success {
            border-left: 4px solid #51cf66;
        }
        
        .toast-error {
            border-left: 4px solid #fa5252;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .toast-success .toast-icon {
            background-color: #51cf66;
            color: white;
        }
        
        .toast-error .toast-icon {
            background-color: #fa5252;
            color: white;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .toast-errors {
            background-color: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .toast-errors-title {
            font-size: 13px;
            font-weight: 600;
            color: #c53030;
            margin-bottom: 6px;
        }
        
        .toast-errors-list {
            font-size: 13px;
            color: #c53030;
            line-height: 1.3;
        }
        
        .toast-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toast-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .toast-btn-primary {
            background-color: #228be6;
            color: white;
        }
        
        .toast-btn-primary:hover {
            background-color: #1c7ed6;
        }
        
        .toast-btn-secondary {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }
        
        .toast-btn-secondary:hover {
            background-color: #e9ecef;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 18px;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            background-color: #f8f9fa;
            color: #212529;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .output-folders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .output-folders-table thead {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .output-folders-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .output-folders-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
            color: #495057;
        }
        
        .output-folders-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .output-folders-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .template-name-cell {
            font-weight: 500;
            color: #212529;
        }
        
        .created-date-cell {
            color: #6c757d;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 13px;
        }
        
        .table-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .table-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .table-btn-primary {
            background-color: #228be6;
            color: white;
        }
        
        .table-btn-primary:hover {
            background-color: #1c7ed6;
        }
        
        .table-btn-secondary {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }
        
        .table-btn-secondary:hover {
            background-color: #e9ecef;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>
                    <div class="app-icon"></div>
                    DocuFill
                </h2>
            </div>
            <nav class="sidebar-nav">
                <button class="sidebar-item active" onclick="showPage('fill')">
                    <span>📝</span> Fill Templates
                </button>
                <button class="sidebar-item" onclick="showPage('folders')">
                    <span>📁</span> Browse Folders
                </button>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Fill Templates Page -->
            <div id="fill-page" class="page active">
                <div class="header">
                    <h1>Fill Document Templates</h1>
                    <p>Select a template and fill out the required fields</p>
                </div>
                
                <!-- Template Selection -->
                <div id="template-selection">
                    <div class="card">
                        <div id="templates-loading" class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <span>Loading templates...</span>
                        </div>
                        <div id="templates-list" class="template-grid"></div>
                    </div>
                </div>
                
                <!-- Form Section -->
                <div id="form-section" style="display: none;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                            <div>
                                <h3 id="form-title" style="margin-bottom: 4px;"></h3>
                                <p id="form-subtitle" style="color: #6c757d; font-size: 14px;"></p>
                            </div>
                            <button class="btn btn-outline" onclick="backToSelection()">
                                ← Back
                            </button>
                        </div>
                        
                        <div id="alert-container"></div>
                        
                        <div id="form-title-section" style="display: none; margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border-left: 4px solid #228be6; display: flex; align-items: center; justify-content: center; min-height: 60px;">
                            <h2 id="form-main-title" style="margin: 0; font-size: 24px; font-weight: 700; color: #212529; text-align: center;"></h2>
                            <p id="form-main-subtitle" style="margin: 0; color: #6c757d; font-size: 16px; text-align: center;"></p>
                        </div>
                        
                        <form id="template-form">
                            <div id="form-fields"></div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    ✓ Fill Documents
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    ↺ Reset Form
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Browse Folders Page -->
            <div id="folders-page" class="page">
                <div class="header">
                    <h1>Browse Folders</h1>
                    <p>Access your templates and output files</p>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: #212529; margin-bottom: 16px;">Templates</h2>
                    <div id="browse-templates-loading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <span>Loading templates...</span>
                    </div>
                    <div id="browse-templates-list" class="template-grid"></div>
                </div>
                
                <div>
                    <h2 style="font-size: 20px; font-weight: 600; color: #212529; margin-bottom: 16px;">Output</h2>
                    <div class="card">
                        <!-- Header Section -->
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e9ecef;">
                            <div class="folder-icon" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px;">📄</div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 600; color: #212529;">Output Folder</h3>
                                <p style="margin: 0; color: #6c757d; font-size: 14px;">
                                    View your filled documents with timestamp naming
                                </p>
                            </div>
                            <button class="btn btn-outline" onclick="openFolder('output')">
                                Open Folder
                            </button>
                        </div>
                        
                        <!-- Latest Output Folders Section -->
                        <div>
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #212529;">Latest Output Folders</h4>
                            <div id="output-folders-loading" class="loading" style="display: none;">
                                <div class="spinner"></div>
                                <span>Loading output folders...</span>
                            </div>
                            <div id="output-folders-table-container" style="display: none;">
                                <table class="output-folders-table">
                                    <thead>
                                        <tr>
                                            <th>Template</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="output-folders-tbody">
                                    </tbody>
                                </table>
                            </div>
                            <div id="output-folders-empty" style="display: none; text-align: center; padding: 40px; color: #6c757d;">
                                <div style="font-size: 48px; margin-bottom: 16px;">📁</div>
                                <p style="font-size: 16px; margin-bottom: 8px;">No output folders found</p>
                                <p style="font-size: 14px;">Create some documents to see them here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        let currentTemplate = null;
        let templateFields = [];

        // Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Hide all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId + '-page').classList.add('active');
            
            // Highlight selected sidebar item
            event.target.classList.add('active');
            
            // Load templates when showing fill page or folders page
            if (pageId === 'fill') {
                loadTemplates();
            } else if (pageId === 'folders') {
                loadBrowseTemplates();
                loadOutputFolders();
            }
        }

        // Load available templates
        async function loadTemplates() {
            const templatesLoading = document.getElementById('templates-loading');
            const templatesList = document.getElementById('templates-list');
            
            templatesLoading.style.display = 'flex';
            templatesList.innerHTML = '';
            
            try {
                const templates = await pywebview.api.get_templates();
                templatesLoading.style.display = 'none';
                
                if (templates.length === 0) {
                    templatesList.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 16px;">📁</div>
                            <p style="font-size: 16px; margin-bottom: 8px;">No templates found</p>
                            <p style="font-size: 14px;">Add template folders to the templates directory to get started</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort templates alphabetically by name
                templates.sort((a, b) => a.name.localeCompare(b.name));
                
                for (const template of templates) {
                    // Validate template
                    const validation = await pywebview.api.validate_template(template.name);
                    const isValid = validation.valid;
                    
                    // Get field count for valid templates
                    let fieldCount = 0;
                    if (isValid) {
                        try {
                            const fields = await pywebview.api.get_template_fields(template.name);
                            fieldCount = fields.length;
                        } catch (error) {
                            console.warn(`Could not get fields for ${template.name}:`, error);
                        }
                    }
                    
                    const templateCard = document.createElement('div');
                    templateCard.className = 'template-card' + (isValid ? '' : ' invalid');
                    
                    const statusBadge = isValid 
                        ? '<span class="badge badge-success">✓ Valid</span>'
                        : '<span class="badge badge-error">✗ Invalid</span>';
                    
                    templateCard.innerHTML = `
                        <div class="template-icon">${isValid ? '📄' : '⚠️'}</div>
                        <div class="template-name">${template.name}${statusBadge}</div>
                        <div class="template-info">📝 Documents: ${template.file_count}</div>
                        <div class="template-info">📋 Fields: ${fieldCount}</div>
                        ${!isValid ? `<div class="form-note" style="margin-top: 12px; color: #c92a2a;">
                            Click to see ${validation.errors.length} error(s)
                        </div>` : ''}
                    `;
                    
                    // Set click handler after innerHTML to avoid overwriting
                    if (isValid) {
                        templateCard.onclick = () => selectTemplate(template);
                    } else {
                        templateCard.onclick = () => showTemplateErrors(template, validation);
                    }
                    
                    templatesList.appendChild(templateCard);
                }
            } catch (error) {
                templatesLoading.style.display = 'none';
                console.error('Error loading templates:', error);
                showAlert('Error loading templates: ' + error, 'error');
            }
        }

        // Load templates for browse folders page
        async function loadBrowseTemplates() {
            const templatesLoading = document.getElementById('browse-templates-loading');
            const templatesList = document.getElementById('browse-templates-list');
            
            templatesLoading.style.display = 'flex';
            templatesList.innerHTML = '';
            
            try {
                const templates = await pywebview.api.get_templates();
                templatesLoading.style.display = 'none';
                
                if (templates.length === 0) {
                    templatesList.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 16px;">📁</div>
                            <p style="font-size: 16px; margin-bottom: 8px;">No templates found</p>
                            <p style="font-size: 14px;">Add template folders to the templates directory to get started</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort templates alphabetically by name
                templates.sort((a, b) => a.name.localeCompare(b.name));
                
                for (const template of templates) {
                    // Validate template
                    const validation = await pywebview.api.validate_template(template.name);
                    const isValid = validation.valid;
                    
                    // Get field count for valid templates
                    let fieldCount = 0;
                    if (isValid) {
                        try {
                            const fields = await pywebview.api.get_template_fields(template.name);
                            fieldCount = fields.length;
                        } catch (error) {
                            console.warn(`Could not get fields for ${template.name}:`, error);
                        }
                    }
                    
                    const templateCard = document.createElement('div');
                    templateCard.className = 'template-card' + (isValid ? '' : ' invalid');
                    
                    const statusBadge = isValid 
                        ? '<span class="badge badge-success">✓ Valid</span>'
                        : '<span class="badge badge-error">✗ Invalid</span>';
                    
                    templateCard.innerHTML = `
                        <div class="template-icon">${isValid ? '📄' : '⚠️'}</div>
                        <div class="template-name">${template.name}${statusBadge}</div>
                        <div class="template-info">📝 Documents: ${template.file_count}</div>
                        <div class="template-info">📋 Fields: ${fieldCount}</div>
                        ${!isValid ? `<div class="form-note" style="margin-top: 12px; color: #c92a2a;">
                            Click to see ${validation.errors.length} error(s)
                        </div>` : ''}
                    `;
                    
                    // Set click handler to open template folder
                    templateCard.onclick = () => openTemplateFolder(template.name);
                    
                    templatesList.appendChild(templateCard);
                }
            } catch (error) {
                templatesLoading.style.display = 'none';
                console.error('Error loading browse templates:', error);
            }
        }

        // Show template validation errors
        function showTemplateErrors(template, validation) {
            console.log('showTemplateErrors called with:', { template, validation });
            
            try {
                // Check if errors array exists and has content
                if (!validation.errors || !Array.isArray(validation.errors)) {
                    console.error('Invalid errors array:', validation.errors);
                    showAlert('Invalid validation data: errors array is missing or not an array', 'error');
                    return;
                }
                
                // Hide template selection and show form section with errors
                document.getElementById('template-selection').style.display = 'none';
                document.getElementById('form-section').style.display = 'block';
                
                // Update form title and subtitle
                document.getElementById('form-title').textContent = `${template.name} - Validation Errors`;
                document.getElementById('form-subtitle').textContent = `${validation.errors.length} error(s) found`;
                
                // Show the main form title section for error display
                const titleSection = document.getElementById('form-title-section');
                const mainTitle = document.getElementById('form-main-title');
                const mainSubtitle = document.getElementById('form-main-subtitle');
                
                titleSection.style.display = 'flex';
                mainTitle.textContent = template.name;
                mainSubtitle.textContent = '';
                
                // Clear any existing form fields
                document.getElementById('form-fields').innerHTML = '';
                
                // Create error display
                const errorContainer = document.createElement('div');
                errorContainer.style.marginBottom = '24px';
                
                let errorHTML = '<div style="background: #ffe0e0; border: 1px solid #ffa8a8; border-radius: 8px; padding: 16px;">';
                errorHTML += '<h4 style="color: #c92a2a; margin-bottom: 12px; font-size: 16px;">⚠️ Template Validation Errors</h4>';
                
                // Add errors
                if (validation.errors.length > 0) {
                    errorHTML += '<div style="margin-bottom: 16px;">';
                    errorHTML += '<strong style="color: #c92a2a;">Errors:</strong><br>';
                    validation.errors.forEach(error => {
                        errorHTML += `<div style="margin: 4px 0; padding-left: 16px; color: #c92a2a;">• ${error}</div>`;
                    });
                    errorHTML += '</div>';
                }
                
                // Add warnings if any
                if (validation.warnings && validation.warnings.length > 0) {
                    errorHTML += '<div style="margin-bottom: 16px;">';
                    errorHTML += '<strong style="color: #e67700;">Warnings:</strong><br>';
                    validation.warnings.forEach(warning => {
                        errorHTML += `<div style="margin: 4px 0; padding-left: 16px; color: #e67700;">• ${warning}</div>`;
                    });
                    errorHTML += '</div>';
                }
                
                errorHTML += '<div style="color: #6c757d; font-size: 14px; margin-top: 12px;">';
                errorHTML += 'Please fix these issues before using the template. Check the template folder and configuration files.';
                errorHTML += '</div>';
                errorHTML += '</div>';
                
                errorContainer.innerHTML = errorHTML;
                document.getElementById('form-fields').appendChild(errorContainer);
                
                // Hide the button group for error display
                const btnGroup = document.querySelector('.btn-group');
                if (btnGroup) {
                    btnGroup.style.display = 'none';
                }
                
                // Clear any existing alerts
                clearAlert();
                
            } catch (error) {
                console.error('Error in showTemplateErrors:', error);
                showAlert('Error showing template errors: ' + error.message, 'error');
            }
        }

        // Select template and load form
        async function selectTemplate(template) {
            currentTemplate = template;
            
            try {
                templateFields = await pywebview.api.get_template_fields(template.name);
                
                if (templateFields.length === 0) {
                    showAlert('No fields found in template configuration', 'error');
                    return;
                }
                
                showForm();
            } catch (error) {
                console.error('Error loading template fields:', error);
                showAlert('Error loading template fields: ' + error, 'error');
            }
        }

        // Show form for selected template
        function showForm() {
            document.getElementById('template-selection').style.display = 'none';
            document.getElementById('form-section').style.display = 'block';
            document.getElementById('form-title').textContent = currentTemplate.name;
            document.getElementById('form-subtitle').textContent = `${templateFields.length} fields • ${currentTemplate.file_count} documents`;
            
            // Show and populate the main form title section
            const titleSection = document.getElementById('form-title-section');
            const mainTitle = document.getElementById('form-main-title');
            const mainSubtitle = document.getElementById('form-main-subtitle');
            
            titleSection.style.display = 'block';
            mainTitle.textContent = currentTemplate.name;
            mainSubtitle.textContent = '';
            
            const formFields = document.getElementById('form-fields');
            formFields.innerHTML = '';
            
            templateFields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const fieldId = `field_${field.key}`;
                
                let inputHTML = '';
                if (field.multiple) {
                    inputHTML = `
                        <div id="${fieldId}_container">
                            <div class="value-input-group">
                                <input type="text" class="value-input" id="${fieldId}_0" placeholder="Enter value">
                                <button type="button" class="remove-value-btn" onclick="removeValueInput('${fieldId}', 0)" style="display: none;">×</button>
                            </div>
                        </div>
                        <button type="button" class="add-value-btn" onclick="addValueInput('${fieldId}')">+</button>
                    `;
                } else {
                    inputHTML = `<input type="text" class="form-input" id="${fieldId}" name="${field.key}">`;
                }
                
                const noteHTML = field.note && field.note !== 'nan' 
                    ? `<div class="form-note">💡 ${field.note}</div>` 
                    : '';
                
                formGroup.innerHTML = `
                    <label class="form-label" for="${fieldId}">
                        ${field.label}
                        ${field.multiple ? '<span style="color: #228be6; font-size: 12px;">(multiple values)</span>' : ''}
                    </label>
                    ${inputHTML}
                    ${noteHTML}
                `;
                
                formFields.appendChild(formGroup);
            });
            
            // Show the button group for normal form
            const btnGroup = document.querySelector('.btn-group');
            if (btnGroup) {
                btnGroup.style.display = 'flex';
            }
            
            clearAlert();
        }

        // Handle multiple value inputs
        function addValueInput(fieldId) {
            const container = document.getElementById(fieldId + '_container');
            const existingInputs = container.querySelectorAll('.value-input-group');
            const newIndex = existingInputs.length;
            
            const newInputGroup = document.createElement('div');
            newInputGroup.className = 'value-input-group';
            newInputGroup.innerHTML = `
                <input type="text" class="value-input" id="${fieldId}_${newIndex}" placeholder="Enter value">
                <button type="button" class="remove-value-btn" onclick="removeValueInput('${fieldId}', ${newIndex})">×</button>
            `;
            
            container.appendChild(newInputGroup);
            
            // Show remove buttons for all inputs if there's more than one
            if (existingInputs.length >= 1) {
                existingInputs[0].querySelector('.remove-value-btn').style.display = 'flex';
            }
            
            // Focus the new input
            document.getElementById(`${fieldId}_${newIndex}`).focus();
        }

        function removeValueInput(fieldId, index) {
            const container = document.getElementById(fieldId + '_container');
            const inputGroups = container.querySelectorAll('.value-input-group');
            
            if (inputGroups.length <= 1) {
                return; // Don't remove the last input
            }
            
            // Remove the specific input group
            inputGroups[index].remove();
            
            // Re-index remaining inputs
            const remainingGroups = container.querySelectorAll('.value-input-group');
            remainingGroups.forEach((group, newIndex) => {
                const input = group.querySelector('.value-input');
                const removeBtn = group.querySelector('.remove-value-btn');
                
                input.id = `${fieldId}_${newIndex}`;
                removeBtn.onclick = () => removeValueInput(fieldId, newIndex);
            });
            
            // Hide remove button if only one input remains
            if (remainingGroups.length === 1) {
                remainingGroups[0].querySelector('.remove-value-btn').style.display = 'none';
            }
        }

        // Get form data
        function getFormData() {
            const formData = {};
            
            templateFields.forEach(field => {
                const fieldId = `field_${field.key}`;
                
                if (field.multiple) {
                    const inputs = document.querySelectorAll(`#${fieldId}_container .value-input`);
                    formData[field.key] = Array.from(inputs)
                        .map(input => input.value.trim())
                        .filter(value => value !== ''); // Remove empty values
                } else {
                    const input = document.getElementById(fieldId);
                    formData[field.key] = input.value.trim();
                }
            });
            
            return formData;
        }

        // Reset form
        function resetForm() {
            document.getElementById('template-form').reset();
            
            // Reset multiple value inputs to single input
            templateFields.forEach(field => {
                if (field.multiple) {
                    const fieldId = `field_${field.key}`;
                    const container = document.getElementById(fieldId + '_container');
                    if (container) {
                        // Keep only the first input, remove others
                        const inputGroups = container.querySelectorAll('.value-input-group');
                        for (let i = 1; i < inputGroups.length; i++) {
                            inputGroups[i].remove();
                        }
                        
                        // Clear the first input and hide its remove button
                        const firstInput = container.querySelector('.value-input');
                        if (firstInput) {
                            firstInput.value = '';
                        }
                        const firstRemoveBtn = container.querySelector('.remove-value-btn');
                        if (firstRemoveBtn) {
                            firstRemoveBtn.style.display = 'none';
                        }
                    }
                }
            });
            
            clearAlert();
        }

        // Submit form
        document.getElementById('template-form').onsubmit = async function(event) {
            event.preventDefault();
            
            const formData = getFormData();
            const submitBtn = document.getElementById('submit-btn');
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Filling documents...';
            
            try {
                const result = await pywebview.api.fill_documents(currentTemplate.name, formData);
                
                if (result.success) {
                    // Extract output folder name from the first file path
                    let outputFolder = null;
                    if (result.files && result.files.length > 0) {
                        const firstFile = result.files[0];
                        // Extract folder name (format: folder/filename)
                        const pathParts = firstFile.split('/');
                        if (pathParts.length > 1) {
                            outputFolder = pathParts[0];
                        }
                    }
                    
                    const fileCount = result.files ? result.files.length : 0;
                    const message = `Successfully created ${fileCount} document${fileCount !== 1 ? 's' : ''}`;
                    
                    showSuccessToast('Documents Created!', message, outputFolder);
                    resetForm();
                    backToSelection();
                } else {
                    const errors = result.errors || [];
                    showErrorToast('Document Creation Failed', result.message, errors);
                }
            } catch (error) {
                console.error('Error filling document:', error);
                showErrorToast('Error', 'Failed to fill documents: ' + error);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = '✓ Fill Documents';
            }
        };

        // Back to template selection
        function backToSelection() {
            document.getElementById('form-section').style.display = 'none';
            document.getElementById('template-selection').style.display = 'block';
            
            // Hide the main form title section when returning to selection
            const titleSection = document.getElementById('form-title-section');
            titleSection.style.display = 'none';
            
            // Show the button group when returning to selection
            const btnGroup = document.querySelector('.btn-group');
            if (btnGroup) {
                btnGroup.style.display = 'flex';
            }
            
            clearAlert();
            currentTemplate = null;
            templateFields = [];
        }

        // Open folder
        async function openFolder(folderType) {
            try {
                const result = await pywebview.api.open_folder(folderType);
                console.log(result.message);
            } catch (error) {
                console.error('Error opening folder:', error);
            }
        }

        // Open specific template folder
        async function openTemplateFolder(templateName) {
            try {
                const result = await pywebview.api.open_template_folder(templateName);
                console.log(result.message);
            } catch (error) {
                console.error('Error opening template folder:', error);
            }
        }

        // Alert functions
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const icon = type === 'success' ? '✓' : type === 'error' ? '✗' : '⚠';
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    <div style="font-size: 20px;">${icon}</div>
                    <div style="flex: 1;">${message}</div>
                </div>
            `;
            
            // Scroll to alert
            alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function clearAlert() {
            document.getElementById('alert-container').innerHTML = '';
        }

        // Toast notification functions
        function showToast(type, title, message, options = {}) {
            const container = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            
            let toastHTML = `
                <div id="${toastId}" class="toast toast-${type}">
                    <div class="toast-icon">${type === 'success' ? '✓' : '✗'}</div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
            `;
            
            // Add errors if provided
            if (options.errors && options.errors.length > 0) {
                toastHTML += `
                    <div class="toast-errors">
                        <div class="toast-errors-title">Errors:</div>
                        <div class="toast-errors-list">${options.errors.map(e => `• ${e}`).join('<br>')}</div>
                    </div>
                `;
            }
            
            // Add actions
            toastHTML += '<div class="toast-actions">';
            
            if (options.actions) {
                options.actions.forEach(action => {
                    toastHTML += `
                        <button class="toast-btn toast-btn-${action.type}" onclick="${action.onclick}">
                            ${action.icon ? action.icon + ' ' : ''}${action.text}
                        </button>
                    `;
                });
            }
            
            toastHTML += `
                    </div>
                </div>
                <button class="toast-close" onclick="hideToast('${toastId}')">×</button>
            </div>
            `;
            
            container.insertAdjacentHTML('beforeend', toastHTML);
            
            // Auto-hide after 8 seconds unless it has actions
            if (!options.actions || options.actions.length === 0) {
                setTimeout(() => hideToast(toastId), 8000);
            }
        }

        function hideToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }

        function showSuccessToast(title, message, outputFolder = null) {
            const actions = [];
            
            if (outputFolder) {
                actions.push({
                    type: 'primary',
                    text: 'Open Folder',
                    icon: '📁',
                    onclick: `openOutputFolder('${outputFolder}')`
                });
            }
            
            showToast('success', title, message, { actions });
        }

        function showErrorToast(title, message, errors = []) {
            showToast('error', title, message, { errors });
        }

        async function openOutputFolder(folderName) {
            try {
                // Extract timestamp from folder name (format: timestamp_template-name)
                const parts = folderName.split('_');
                if (parts.length >= 2) {
                    const timestamp = parts[0];
                    const templateName = parts.slice(1).join('_');
                    
                    // Open the specific output folder
                    const result = await pywebview.api.open_output_folder(folderName);
                    console.log(result.message);
                }
            } catch (error) {
                console.error('Error opening output folder:', error);
            }
        }

        // Load output folders table
        async function loadOutputFolders() {
            const loading = document.getElementById('output-folders-loading');
            const tableContainer = document.getElementById('output-folders-table-container');
            const emptyState = document.getElementById('output-folders-empty');
            const tbody = document.getElementById('output-folders-tbody');
            
            loading.style.display = 'flex';
            tableContainer.style.display = 'none';
            emptyState.style.display = 'none';
            
            try {
                const folders = await pywebview.api.get_latest_output_folders(10);
                loading.style.display = 'none';
                
                if (folders.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                // Clear existing rows
                tbody.innerHTML = '';
                
                // Add rows for each folder
                folders.forEach(folder => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="template-name-cell">${folder.template_name}</td>
                        <td class="created-date-cell">${folder.created_date}</td>
                        <td>
                            <div class="table-actions">
                                <button class="table-btn table-btn-primary" onclick="openOutputFolder('${folder.name}')">
                                    📁 Open
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                tableContainer.style.display = 'block';
                
            } catch (error) {
                loading.style.display = 'none';
                console.error('Error loading output folders:', error);
                emptyState.style.display = 'block';
            }
        }

        // Initialize app
        window.addEventListener('pywebviewready', function() {
            loadTemplates();
        });
    </script>
</body>
</html>

